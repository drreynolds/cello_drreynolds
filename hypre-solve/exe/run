#!/bin/tcsh

#-----------------------------------------------------------------------
# Generate an input file via hypre-init, and run hypre-solve
#
# Usage: arguments are passed directly to hypre-init.  See hypre-init
#        for usage
#-----------------------------------------------------------------------

set PATH = `pwd`
set bin = "$PATH/../bin"

set extra = "dump_x true\n"
if ($2 <= 32) then
   set extra = "${extra}dump_a true\ndump_b true\n"
endif


#----------------------------------------------------------------------
# INITIALIZE PROBLEM
#----------------------------------------------------------------------

set problem = "N$1.P$2$3$4.L$5.O$6.S$7.$8"

set input = in.$problem

#----------------------------------------------------------------------
# CLEAN UP PREVIOUS RUN IF ANY
#----------------------------------------------------------------------

if (-e $problem) then
   rm -rf "$problem"
endif

#----------------------------------------------------------------------
# GENERATE THE INPUT FILE
#----------------------------------------------------------------------

$bin/hypre-init $1 $2 $3 $4 $5 $6 $7 $8
printf "$extra" >> $input
mv $input $problem
cd $problem

#----------------------------------------------------------------------
# RUN THE PROBLEM
#----------------------------------------------------------------------

@ np = $2 * $3 * $4 

if ($7 == 1) then
   $bin/hypre-solve $input >& outfile
else
   if ($HOST == "ds100") then
      @ nodes = ($np - 1) / 8 + 1
      if ($np < 8) then
         set procs = $np
      else
         set procs = 8
      endif
      (poe $bin/hypre-solve $input \
           -nodes          $nodes \
           -tasks_per_node $procs \
           -rmpool         1) >& outfile
   else
#      /usr/local/sbin/cleanipcs
      mpirun -np $np $bin/hypre-solve $input >& outfile
      killall -q hypre-solve
   endif
endif

#----------------------------------------------------------------------
# GENERATE PLOTS
#----------------------------------------------------------------------

$bin/hypre-png 3 4 X.? X.?? >& out.hypre-png
mv project-0.png X0.png
mv project-1.png X1.png
mv project-2.png X2.png

#----------------------------------------------------------------------
# DISPLAY RESULT
#----------------------------------------------------------------------

set success = `grep "Success hypre-solve" outfile | wc`
set success = $success[1]
if ($success == 1) then
   echo "Pass: $problem"
else
   echo "Fail: $problem"
endif


#-----------------------------------------------------------------------
#
# @file    Makefile
# @brief   Top-level makefile
# @author  James Bordner
# @version 1.0
#
# Targets
#
# (*) all
# (*) clean
# (*) test
# (*) doc
# (*) dep
# (*) install
# (*) install-include
#
# Directories
#
# (*) Array
# (*) Disk
# (*) Error
# (*) Memory
# ( ) Method
# (*) Parameters
# (*) Performance
# (*) Test
#
#-----------------------------------------------------------------------

DIR = \
      Amr \
      Array \
      Control \
      Disk \
      Error \
      Memory \
      Method \
      Monitor \
      Parallel \
      Parameters \
      Performance \
      Test

#=======================================================================
# TARGETS
#=======================================================================

.PHONY: all %-component
all: install-include dep $(patsubst %,%-component,$(DIR))
%-component:  %-DEP
	-@($(MAKE)  -C $*)

#-----------------------------------------------------------------------

.PHONY: clean %-clean
clean:   $(patsubst %,%-clean,$(DIR))
%-clean:  %-DEP
	-@rm -f *~
	-@($(MAKE) -s -C $* clean)

#-----------------------------------------------------------------------

# Run tests in Test directory, and display results in Tests/*.unit

.PHONY: 
run-tests: all install $(patsubst %,%-run-tests,$(DIR))
	-@echo
	-@echo "=================================================="
	-@echo "FAILED TESTS:"
	-@echo "=================================================="
	-@echo
	-@grep FAIL */*unit
	-@echo

%-run-tests:
	$(MAKE) -s -C $* run-tests

#-----------------------------------------------------------------------

.PHONY: dep %-dep
dep:       $(patsubst %,%-dep,$(DIR))
%-dep: %-DEP
	$(MAKE) -s -C $* dep
.PHONY: %-DEP
%-DEP:
	-@(touch $*/DEPEND)

#-----------------------------------------------------------------------

.PHONY: install %-install
install:   $(patsubst %,%-install,$(DIR))
%-install: %-DEP
	-@($(MAKE) -s -C $* install)

#-----------------------------------------------------------------------

.PHONY: install-include %-install-include
install-include:   $(patsubst %,%-install-include,$(DIR))
%-install-include: %-DEP
	-@$(MAKE) -s -C $* install-include

#-----------------------------------------------------------------------

.PHONY: doc
doc:
	doxygen

#-----------------------------------------------------------------------

.PHONY: cccc
cccc:
	cccc */*.cpp

#-----------------------------------------------------------------------
# Package dependencies
#-----------------------------------------------------------------------

.PHONY: Amr

Amr-component: Disk-component
Amr-component: Error-component
Amr-component: Memory-component
Amr-component: Monitor-component

Array-component: Error-component
Array-component: Test-component

Control-component: Error-component
Control-component: Monitor-component
Control-component: Parameters-component
Control-component: Test-component

Disk-component: Array-component
Disk-component: Error-component
Disk-component: Test-component

Error-component: Test-component

Memory-component: Error-component
Memory-component: Test-component

Method-component: Disk-component
Method-component: Error-component
Method-component: Performance-component

Monitor-component: Performance-component

Parallel-component: Error-component
Parallel-component: Parameters-component
Parallel-component: Performance-component

Parameters-component: Error-component
Parameters-component: Test-component

Performance-component: Error-component
Performance-component: Memory-component
Performance-component: Test-component

